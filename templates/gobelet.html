{% extends "base.html" %}
{% block title %}Gobelet personnalis√©{% endblock %}

{% block content %}
<div class="container gobelet-container">
    <div class="image-box">
        <img id="cup-preview"
             alt="Aper√ßu gobelet"
             src="{{ url_for('static', filename='img/gobelets/gobelet_blanc.png') }}"
             style="max-width:300px; border-radius:10px;">
    </div>


    <div class="form-box">
        <h2>Gobelet personnalis√©</h2>

        {# ---- Infos Strava ---- #}
        {% if strava_connected %}
        <div class="alert alert-success" style="margin-top: 0.5rem;">
            üîó Compte Strava connect√©
        </div>
        {% elif user_has_strava_linked %}
        <div class="alert alert-warning" style="margin-top: 0.5rem;">
            ‚ö†Ô∏è Votre compte Strava est li√©, mais vous devez vous reconnecter.
        </div>
        {% endif %}

        <p class="price">CHF 12.90 ‚Äî TVA incluse</p>
        <p>Ajoutez votre performance ou le trac√© de votre course pour personnaliser votre gobelet.</p>

        {# ---- Strava connect√© ---- #}
        {% if strava_connected %}
        {% if selected_activity %}
        <div class="strava-import-box">
            <h3>‚úÖ Activit√© Strava import√©e</h3>
            <p><b>{{ selected_activity.name }}</b></p>
            <ul>
                <li>Distance : {{ selected_activity.distance }} km</li>
                <li>Temps : {{ selected_activity.time }}</li>
                <li>Allure : {{ selected_activity.pace }}/km</li>
            </ul>

            <p style="font-size:0.9em; color:#777;">
                Les champs ci-dessous sont d√©j√† remplis avec vos donn√©es Strava.
            </p>
        </div>
        {% else %}
        <div class="choice-box" style="margin-bottom: 20px;">
            <h3>Strava connect√© ‚úÖ</h3>
            <p>Vous pouvez maintenant importer une activit√© :</p>
            <a href="{{ url_for('strava.activities') }}" class="btn btn-primary">Voir mes activit√©s Strava</a>
        </div>
        {% endif %}

        {# Bouton d√©connexion Strava #}
        <form action="{{ url_for('strava.disconnect') }}" method="post" style="margin-top:0.5rem;">
            <button type="submit" class="btn btn-danger">D√©connecter Strava</button>
        </form>
        {% else %}
        {% if not strava_just_disconnected %}
        <div class="choice-box" style="margin-bottom: 20px;">
            <h3>Connectez votre compte Strava</h3>
            <form action="{{ url_for('strava.connect') }}" method="get" style="margin-bottom:10px;">
                <button type="submit" style="border:none; background:none; padding:0; cursor:pointer;">
                    <img src="{{ url_for('static', filename='images/btn-strava@1x.png') }}"
                         srcset="{{ url_for('static', filename='images/btn-strava@1x.png') }} 1x,
                           {{ url_for('static', filename='images/btn-strava@2x.png') }} 2x"
                         alt="Se connecter √† Strava"
                         height="48">
                </button>
            </form>
            <p style="font-size:0.9em; color:#777;">
                Ou remplissez les champs manuellement ci-dessous.
            </p>
        </div>
        {% endif %}
        {% endif %}

        {# ---- Formulaire principal ---- #}
        <form enctype="multipart/form-data" method="post">

            <label>Couleur</label>
            <select name="color" required>
                <option value="blanc">Blanc</option>
                <option value="noir">Noir</option>
                <option value="bleu">Bleu</option>
                <option value="rouge">Rouge</option>
            </select>

            <label>Quantit√©</label>
            <input min="1" name="qty" required type="number" value="1">

            <fieldset>
                <legend>Performance</legend>

                <label style="display:flex; align-items:center; gap:8px;">
                    <input id="add-results" name="add_results" type="checkbox"
                           {% if selected_activity %}checked{% endif %}>
                    Ajouter mes r√©sultats (+CHF 5)
                </label>

                <label>Temps</label>
                <input id="time-input"
                       name="time"
                       value="{{ selected_activity.time if selected_activity else '' }}"
                       type="text"
                       inputmode="numeric"
                       placeholder="hh:mm:ss ou mm:ss"
                       pattern="^([0-9]{1,2}:)?[0-5]?[0-9]:[0-5][0-9]$"
                       title="Format attendu : hh:mm:ss ou mm:ss">

                <label>Distance (km)</label>
                <input id="distance-input"
                       name="distance"
                       value="{{ selected_activity.distance if selected_activity else '' }}"
                       type="number"
                       step="0.01"
                       min="0.01"
                       placeholder="ex. 5.00"
                       title="Distance en kilom√®tres, ex. 5.00">
            </fieldset>


            {% if selected_activity and selected_activity.polyline %}
            <fieldset>
                <legend>üó∫Ô∏è Trac√© GPS (+CHF 3)</legend>
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:0.5rem;">
                    <input type="checkbox" name="add_route" checked>
                    Afficher sur mon gobelet
                </label>

                {% if session.track_image_b64 %}
                <img src="data:image/png;base64,{{ session.track_image_b64 }}"
                     alt="Trac√© Strava"
                     style="max-width:300px; border:1px solid #ccc; border-radius:8px;">
                {% else %}
                <p style="font-size:0.9em; color:#999;">Aucun trac√© disponible pour cette activit√©.</p>
                {% endif %}
            </fieldset>
            {% endif %}


            <button type="submit">Ajouter au panier</button>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const colorSelect = document.querySelector("select[name='color']");
        const formatSelect = document.querySelector("select[name='format']"); // si tu as un choix de format
        const cupImg = document.getElementById("cup-preview");

        function updateCupImage() {
            const color = colorSelect ? colorSelect.value : "blanc";
            const format = formatSelect ? formatSelect.value : null;

            // üîπ Cas 1 : format + couleur (si tu as les deux)
            let filename = format ? `gobelet_${format}_${color}.png` : `gobelet_${color}.png`;

            // üîπ Met √† jour l'image (attention au cache navigateur)
            const newSrc = `/static/img/gobelets/${filename}?v=${Date.now()}`;
            cupImg.src = newSrc;
        }

        if (colorSelect) colorSelect.addEventListener("change", updateCupImage);
        if (formatSelect) formatSelect.addEventListener("change", updateCupImage);

        // Fallback si l‚Äôimage n‚Äôexiste pas
        cupImg.onerror = () => {
            cupImg.src = "/static/img/gobelets/gobelet_blanc.png";
        };

    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const checkbox = document.getElementById("add-results");
        const timeInput = document.getElementById("time-input");
        const distanceInput = document.getElementById("distance-input");

        // Fonction qui active/d√©sactive les champs
        const toggleRequired = () => {
            const checked = checkbox.checked;

            timeInput.required = checked;
            distanceInput.required = checked;

            timeInput.disabled = !checked;
            distanceInput.disabled = !checked;

            timeInput.style.opacity = checked ? "1" : "0.6";
            distanceInput.style.opacity = checked ? "1" : "0.6";
        };

        // Ex√©cuter au chargement + √† chaque changement
        toggleRequired();
        checkbox.addEventListener("change", toggleRequired);
    });
</script>

{% endblock %}
